<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="stylesheet" type="text/css" href="../css/tracking-vehicles.css">

<dom-module id="tracking-vehicles">

  <template>
    <iron-ajax
      auto
      id="updateVehicles"
      url="/vehicles"
      handle-as="json"
      last-response="{{vehicles}}">
    </iron-ajax>

    <iron-ajax id="ajaxDelete" method="DELETE"></iron-ajax>

    <div class="vehicle-list">
      <template is="dom-if" if="{{vehicles}}">
        <paper-material class="vehicles-container">
          <h1> Vehicles </h1>
          <template is="dom-repeat" items="{{vehicles}}" as="vehicle">
            <paper-card  class="vehicle-card" elevation="2" contenteditable="false">
              <div class="card-content">
                <font size="+2"> <span id$="{{vehicle.vehicleName}}">{{vehicle.vehicleName}}</font></br></br></br>
                <b> ID: </b> <span id$="{{vehicle.vehicleID}}">{{vehicle.vehicleID}}</span>
              </div>
              <div class="card-actions">
                <paper-icon-button on-click="editVehicle" icon="create" class="create"></paper-icon-button>
                <paper-icon-button on-click="deleteVehicle" icon="delete" class="delete"></paper-icon-button>
              </div>
            </paper-card>
          </template>
        </paper-material>
      </template>
    </div>
    <paper-material class="vehicle-form">
      <h1> New Vehicle </h1>
      <form is="iron-form" id="vehicleForm" content-type="application/json" method="post" action="/vehicles/create">
        <paper-input name="vehicleName" label="Vehicle Name"></paper-input>
        <paper-input name="vehicleID" label="Vehicle ID"></paper-input>
        <br />
        <paper-button raised onclick="submitVehicle()">Submit</paper-button>
      </form>
    </paper-material>

    <!-- <paper-material class="vehicle-form">
      <h1> Edit Vehicle </h1>
      <form is="iron-form" id="vehicleEdit" content-type="application/json" method="post" action="/vehicles/edit">
        <paper-input name="vehicleName" label="Vehicle Name"></paper-input>
        <paper-input name="vehicleID" label="Vehicle ID"></paper-input>
        <br />
        <paper-button raised onclick="submitVehicle()">Submit Updates</paper-button>
      </form>
    </paper-material> -->
  </template>

  <script>
    Polymer({
      is: 'tracking-vehicles',
      listeners: {
        'iron-form-response': 'addVehicleResponse'
      },
      addVehicleResponse: function() {
        this.$.updateVehicles.generateRequest();
      },
      editVehicle: function(e) {
        var model = e.model;
        var vehicle = model.vehicle;
        // this.vehicle.vehicleID = 'asbasdf';
        // this.notifyPath('vehicle.vehicleID');
        var nameElement = document.getElementById(vehicle.vehicleName);
        var idElement = document.getElementById(vehicle.vehicleID);
        if (!idElement.isContentEditable) {
          nameElement.contentEditable = true;
          idElement.contentEditable = true;
        } else {
          nameElement.contentEditable = false;
          idElement.contentEditable = false;
          this.$.ajaxDelete.url = "/vehicles/"+vehicle.vehicleID;
          this.$.ajaxDelete.generateRequest();
          var newVehicle = {};
          newVehicle["vehicleID"] = idElement.innerHTML;
          newVehicle["vehicleName"] = nameElement.textContent;
          var nvString = JSON.stringify(newVehicle);
          var xhr = new XMLHttpRequest();
          xhr.open("POST","/vehicles/create", true);
          xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
          xhr.send(nvString);
          this.$.updateVehicles.generateRequest();
        }
      },
      deleteVehicle: function(e) {
        var id = e.model.vehicle.vehicleID;
        this.$.ajaxDelete.url = "/vehicles/"+id;
        this.$.ajaxDelete.generateRequest();
        this.$.updateVehicles.generateRequest();
      }
    });

    function submitVehicle() {
      var form = document.getElementById("vehicleForm");
      form.submit();
      form.reset();
    }
  </script>
</dom-module>
